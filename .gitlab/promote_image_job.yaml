include:
  local: ".gitlab/common.yaml"

promote:
  image: docker:latest
  stage: promote
  services:
    - docker:dind
  variables:
    CACHE_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
  extends:
    - .docker_settings
  script:
    - apk add git yq
    - git config --global user.email "git@gitlab.com"
    - git config --global user.name "Tenant Bot"
    - >
      git clone \
        https://git:${SELFTOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git \
        tag-commit
    - docker pull $CI_REGISTRY/w1ndblow/ci-cd-example:$CI_COMMIT_SHORT_SHA
    - >
      docker tag $CI_REGISTRY/w1ndblow/ci-cd-example:$CI_COMMIT_SHORT_SHA \
        $CI_REGISTRY/w1ndblow/ci-cd-example:$CI_COMMIT_TAG
    - docker push $CI_REGISTRY/w1ndblow/ci-cd-example:$CI_COMMIT_TAG
    - cd tag-commit
    - export IMAGE_TAG=$CI_REGISTRY/w1ndblow/ci-cd-example:$CI_COMMIT_TAG
    - >
      yq -i ".spec.template.spec.containers[0].image = \"$IMAGE_TAG\"" \
        infrastructure/minikube/apps/deployment.yaml
    - git add --all
    - git commit -m "save state" || true
    - git push origin main

  rules:
    - if: "$CI_COMMIT_TAG =~ /^v.*$/"
